<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Sleep Sessions — DreamDecoder</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <div class="container">
    <div class="card header">
      <div><div class="brand">DreamDecoder</div><div class="small">Sleep sessions</div></div>
      <div class="actions">
        <a href="dashboard.html">Dashboard</a>
        <a href="dreams.html">Dreams</a>
        <a id="logout">Logout</a>
      </div>
    </div>

    <div class="card">
      <h3>Add Sleep Session</h3>
      <form id="sleepForm">
        <div class="form-row">
          <input id="startAt" class="input" type="datetime-local" required />
          <input id="endAt" class="input" type="datetime-local" required />
        </div>
        <div style="display:flex; gap:8px;">
          <button type="submit">Save Session</button>
          <button type="button" id="clearBtn" class="secondary">Clear</button>
        </div>
        <p id="smsg" class="small"></p>
      </form>
    </div>

    <div class="card">
      <h3>Recent Sessions</h3>
      <div id="sessionsList" class="list small">Loading...</div>
    </div>

    <div class="footer center">Tip: Use ISO times (local). Backend stores UTC.</div>
  </div>

  <script src="app.js"></script>
  <script>
    const logoutBtn = document.getElementById('logout');
    logoutBtn?.addEventListener('click', ()=>{ clearToken(); window.location='login.html'; });

    async function loadSessions(){
      const el = document.getElementById('sessionsList');
      el.innerHTML = 'Loading...';
      try{
        const data = await apiFetch('/sleep?limit=20');
        if(!data?.sessions) {
          // some implementations return array directly
          const arr = Array.isArray(data) ? data : [];
          renderSessions(arr); return;
        }
        renderSessions(data.sessions);
      }catch(err){
        el.textContent = 'Error fetching sessions';
      }
    }

    function renderSessions(sessions){
      const el = document.getElementById('sessionsList');
      if(!sessions.length){ el.innerHTML = '<div class="small">No sessions yet</div>'; return;}
      el.innerHTML = '';
      sessions.forEach(s=>{
        const div = document.createElement('div');
        div.className = 'item';
        const info = document.createElement('div');
        info.innerHTML = `<strong>${new Date(s.startAt).toLocaleString()} → ${new Date(s.endAt).toLocaleString()}</strong>
                          <div class="meta">Duration: ${s.durationMinutes ?? Math.round((new Date(s.endAt)-new Date(s.startAt))/60000)} min</div>`;
        const actions = document.createElement('div');
        actions.innerHTML = `<a href="dreams.html?session=${s.id}">Add dream</a>`;
        div.appendChild(info); div.appendChild(actions);
        el.appendChild(div);
      });
    }

    document.getElementById('sleepForm').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const start = document.getElementById('startAt').value;
      const end = document.getElementById('endAt').value;
      const msg = document.getElementById('smsg'); msg.textContent = '';
      if(!start || !end) return msg.textContent = 'Fill both dates';
      try{
        // convert local datetime-local to ISO
        const startISO = new Date(start).toISOString();
        const endISO = new Date(end).toISOString();
        const res = await apiFetch('/sleep', { method:'POST', body: JSON.stringify({ startAt: startISO, endAt: endISO })});
        msg.textContent = 'Saved';
        loadSessions();
      }catch(err){
        msg.textContent = 'Error saving session';
      }
    });

    document.getElementById('clearBtn').addEventListener('click', ()=>{ document.getElementById('startAt').value=''; document.getElementById('endAt').value=''; });

    loadSessions();
  </script>
</body>
</html>
