<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Dreams — DreamDecoder</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <div class="container">
    <div class="card header">
      <div><div class="brand">DreamDecoder</div><div class="small">Dreams & interpretations</div></div>
      <div class="actions">
        <a href="dashboard.html">Dashboard</a>
        <a href="sleep.html">Sleep</a>
        <a id="logout">Logout</a>
      </div>
    </div>

    <div class="card">
      <h3>Add Dream</h3>
      <form id="dreamForm">
        <div class="form-row">
          <input id="sessionId" class="input" placeholder="Session ID (optional)" />
        </div>
        <div>
          <textarea id="dreamText" placeholder="Describe your dream..." required></textarea>
        </div>
        <div style="display:flex; gap:8px; margin-top:8px;">
          <button type="submit">Submit Dream</button>
          <button type="button" id="fetchDreamsBtn" class="secondary">Refresh List</button>
        </div>
        <p id="dmsg" class="small"></p>
      </form>
    </div>

    <div class="card">
      <h3>Recent Dreams</h3>
      <div id="dreamsList" class="list small">Loading...</div>
    </div>
  </div>

  <script src="app.js"></script>
  <script>
    document.getElementById('logout').addEventListener('click', ()=>{ clearToken(); window.location='login.html'; });

    async function fetchDreams(){
      const el = document.getElementById('dreamsList');
      el.innerHTML = 'Loading...';
      try{
        // backend expected /dreams?limit=50 or return array
        const data = await apiFetch('/dreams?limit=50');
        let arr = [];
        if(Array.isArray(data)) arr = data;
        else if(data?.dreams) arr = data.dreams;
        else if(data?.length) arr = data;
        renderDreams(arr);
      }catch(err){
        el.textContent = 'Error fetching dreams';
      }
    }

    function renderDreams(arr){
      const el = document.getElementById('dreamsList');
      if(!arr.length){ el.innerHTML = '<div class="small">No dreams yet</div>'; return; }
      el.innerHTML = '';
      arr.forEach(d=>{
        const div = document.createElement('div');
        div.className = 'item';
        const left = document.createElement('div');
        left.innerHTML = `<strong>${new Date(d.createdAt).toLocaleString()}</strong>
                          <div class="meta">${d.text}</div>`;
        const right = document.createElement('div');
        if(d.processed){
          const interp = JSON.stringify(d.interpretation, null, 2);
          right.innerHTML = `<div class="small">Processed</div>
                             <div class="meta">Summary: ${d.summary ?? '—'}</div>
                             <div class="meta">Stress: ${d.stressScore ?? '—'}</div>
                             <details style="max-width:320px"><summary>View interpretation</summary><pre style="white-space:pre-wrap">${interp}</pre></details>`;
        } else {
          right.innerHTML = `<div class="small">Processing...</div>`;
        }
        div.appendChild(left); div.appendChild(right);
        el.appendChild(div);
      });
    }

    document.getElementById('dreamForm').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const text = document.getElementById('dreamText').value.trim();
      const sessionId = document.getElementById('sessionId').value.trim() || undefined;
      const msg = document.getElementById('dmsg'); msg.textContent = '';
      if(!text) return msg.textContent = 'Enter dream text';
      try{
        // get userId from JWT
        const token = getToken();
        const payload = decodeJwt(token) || {};
        const userId = payload.id || localStorage.getItem('dd_userId');
        const body = { userId, text };
        if(sessionId) body.sleepSessionId = sessionId;
        const res = await apiFetch('/dreams', { method:'POST', body: JSON.stringify(body) });
        msg.textContent = 'Dream saved. Worker will process soon.';
        document.getElementById('dreamText').value = '';
        fetchDreams();
      }catch(err){
        msg.textContent = 'Error adding dream';
      }
    });

    document.getElementById('fetchDreamsBtn').addEventListener('click', fetchDreams);

    // load on open
    fetchDreams();
  </script>
</body>
</html>
